<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Corazón con Series de Fourier (Epiciclos)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #10151c;
      --text: #eaeef4;
      --muted: #8fa3b6;
      --accent: #5eead4;
      --trace: #f43f5e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 70% -10%, #111827 0%, var(--bg) 50%);
      color: var(--text);
      display: grid; place-items: center;
    }
    .wrap { width: min(1100px, 95vw); }
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.0));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    h1 { margin: 6px 0 12px; font-size: clamp(20px, 3.3vw, 34px); letter-spacing: 0.3px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items: center; margin-bottom: 10px; }
    .controls .item { background: var(--panel); border-radius: 14px; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.08); }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="range"] { width: 100%; }
    .row { display: flex; gap: 12px; align-items: center; }
    .badge { font-variant-numeric: tabular-nums; background: rgba(94,234,212,0.15); border: 1px solid rgba(94,234,212,0.35); color: var(--accent); padding: 3px 8px; border-radius: 999px; font-size: 12px; }
    canvas { width: 100%; height: auto; display: block; background: #0a0f14; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); }
    .legend { display:flex; gap:16px; align-items:center; font-size: 12px; color: var(--muted); margin-top: 8px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display:inline-block; }
    .dot.circ { background: #9ca3af; }
    .dot.vec { background: var(--accent); }
    .dot.trace { background: var(--trace); }
    button { cursor:pointer; background: var(--panel); color: var(--text); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 10px 14px; }
    button:hover { filter: brightness(1.1); }
  </style>
</head>
<body>
  <div class="wrap panel">
    <h1>Corazón con Series de Fourier — Epiciclos</h1>
    <div class="controls">
      <div class="item">
        <label for="armonicos">Número de vectores (armónicos)</label>
        <div class="row">
          <input id="armonicos" type="range" min="1" max="200" value="60" />
          <span class="badge" id="valorArmonicos">60</span>
        </div>
      </div>
      <div class="item">
        <label for="velocidad">Velocidad</label>
        <div class="row">
          <input id="velocidad" type="range" min="0.1" max="3" value="1" step="0.1" />
          <span class="badge" id="valorVelocidad">1.0×</span>
        </div>
      </div>
      <div class="item" style="display:grid; grid-template-columns: auto auto; gap:8px; align-items:center;">
        <button id="pausarReproducir">⏸ Pausar</button>
        <button id="reiniciar">↺ Reiniciar trazo</button>
      </div>
    </div>

    <canvas id="cnv" width="1000" height="650"></canvas>
    <div class="legend">
      <span><span class="dot circ"></span> Circunferencias</span>
      <span><span class="dot vec"></span> Vectores giratorios (epiciclos)</span>
      <span><span class="dot trace"></span> Trazo del corazón</span>
    </div>
  </div>

  <script>
    // Utilidad compleja con objetos {re, im}
    function c(re=0, im=0){ return {re, im}; }
    function cSumar(a,b){ return c(a.re+b.re, a.im+b.im); }
    function cRestar(a,b){ return c(a.re-b.re, a.im-b.im); }
    function cMultiplicar(a,b){ return c(a.re*b.re - a.im*b.im, a.re*b.im + a.im*b.re); }
    function cEscalar(a, s){ return c(a.re*s, a.im*s); }
    function cMagnitud(a){ return Math.hypot(a.re, a.im); }
    function cExponencial(theta){ return c(Math.cos(theta), Math.sin(theta)); }

    // Generar puntos de una curva de corazón suave
    // Fórmula clásica: x=16 sin^3 t, y=13 cos t - 5 cos 2t - 2 cos 3t - cos 4t
    function muestrearCorazon(n){
      const pts = [];
      for(let i=0;i<n;i++){
        const t = (i/n)*2*Math.PI;
        const x = 16*Math.pow(Math.sin(t),3);
        const y = 13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t);
        pts.push(c(x, -y)); // invertir y para coordenadas canvas
      }
      // normalizar a [-1,1] aprox
      let maxR = 0;
      for(const p of pts) maxR = Math.max(maxR, cMagnitud(p));
      return pts.map(p=>c(p.re/maxR, p.im/maxR));
    }

    // DFT compleja de una señal de N puntos (como números complejos)
    function dft(señal){
      const N = señal.length;
      const coeficientes = [];
      // k en rango [-K..K] con K=N/2
      const K = Math.floor(N/2);
      for(let k=-K; k<=K; k++){
        let suma = c(0,0);
        for(let n=0; n<N; n++){
          const phi = -2*Math.PI*k*n/N; // signo negativo para síntesis con e^{+i 2πkt}
          suma = cSumar(suma, cMultiplicar(señal[n], cExponencial(phi)));
        }
        // coeficiente promedio
        suma = cEscalar(suma, 1/N);
        coeficientes.push({k, c: suma, amp: cMagnitud(suma), fase: Math.atan2(suma.im, suma.re)});
      }
      // Ordenar por amplitud descendente (mejor convergencia visual)
      coeficientes.sort((a,b)=> b.amp - a.amp);
      return coeficientes;
    }

    // Canvas y estado
    const canvas = document.getElementById('cnv');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    const puntosCorazon = muestrearCorazon(1024);
    const coeficientesTodos = dft(puntosCorazon);

    let numArmonicos = parseInt(document.getElementById('armonicos').value,10);
    let velocidad = parseFloat(document.getElementById('velocidad').value);
    let reproduciendo = true;
    let t = 0; // 0..1 ciclo

    const escala = Math.min(W,H)*0.38;
    const centro = {x: W*0.54, y: H*0.50};

    const trazo = [];

    function dibujarCirculo(x,y,r){
      ctx.beginPath();
      ctx.arc(x,y,r,0,2*Math.PI);
      ctx.globalAlpha = 0.25;
      ctx.strokeStyle = '#9ca3af';
      ctx.lineWidth = 1;
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    function dibujarVector(x,y,dx,dy){
      const x2 = x+dx, y2=y+dy;
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.lineTo(x2,y2);
      ctx.strokeStyle = '#5eead4';
      ctx.lineWidth = 2;
      ctx.stroke();
      // punta de flecha
      const ang = Math.atan2(dy,dx);
      const ah = 6; // tamaño cabeza
      ctx.beginPath();
      ctx.moveTo(x2, y2);
      ctx.lineTo(x2 - ah*Math.cos(ang-0.4), y2 - ah*Math.sin(ang-0.4));
      ctx.lineTo(x2 - ah*Math.cos(ang+0.4), y2 - ah*Math.sin(ang+0.4));
      ctx.closePath();
      ctx.fillStyle = '#5eead4';
      ctx.fill();
      return {x:x2,y:y2};
    }

    function sintetizarPunto(tNorm, coeficientes){
      // x(t) = Σ C_k e^{i 2π k t}
      let z = c(0,0);
      for(const {k, c:ck} of coeficientes){
        const phi = 2*Math.PI*k*tNorm;
        const rot = cExponencial(phi);
        z = cSumar(z, cMultiplicar(ck, rot));
      }
      return z;
    }

    function paso(dt){
      if(!reproduciendo) return;
      t = (t + dt*velocidad) % 1;
    }

    function renderizar(){
      ctx.clearRect(0,0,W,H);

      // Fondo sutil de cuadrícula
      ctx.save();
      ctx.globalAlpha = 0.06;
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 1;
      for(let x=0; x<W; x+=25){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
      for(let y=0; y<H; y+=25){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
      ctx.restore();

      // Selección de coeficientes por amplitud
      const coeficientes = coeficientesTodos.slice(0, numArmonicos);

      // Dibujar epiciclos: cada vector parte de la punta del anterior
      let ox = centro.x, oy = centro.y;
      for(const {k, c:ck} of coeficientes){
        const R = cMagnitud(ck)*escala;
        dibujarCirculo(ox, oy, Math.max(0.5, R));
        const phi = 2*Math.PI*k*t;
        const v = cMultiplicar(ck, cExponencial(phi));
        const fin = dibujarVector(ox, oy, v.re*escala, v.im*escala);
        ox = fin.x; oy = fin.y;
      }

      // Punto actual y trazo acumulado
      const cabeza = {x: ox, y: oy};
      trazo.push(cabeza);
      if(trazo.length > 4000) trazo.shift();

      // Trazo
      ctx.beginPath();
      for(let i=0;i<trazo.length;i++){
        const p = trazo[i];
        if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
      }
      ctx.strokeStyle = '#f43f5e';
      ctx.lineWidth = 2.2;
      ctx.stroke();

      // Punto cabeza
      ctx.beginPath();
      ctx.arc(cabeza.x, cabeza.y, 3.2, 0, 2*Math.PI);
      ctx.fillStyle = '#f43f5e';
      ctx.fill();
    }

    // Bucle
    let ultimo = performance.now();
    function bucle(now){
      const dt = Math.min(0.05, (now - ultimo)/1000); // s
      ultimo = now;
      paso(dt);
      renderizar();
      requestAnimationFrame(bucle);
    }
    requestAnimationFrame(bucle);

    // UI
    const armonicosInp = document.getElementById('armonicos');
    const valorArmonicos = document.getElementById('valorArmonicos');
    const velocidadInp = document.getElementById('velocidad');
    const valorVelocidad = document.getElementById('valorVelocidad');
    const btnPausar = document.getElementById('pausarReproducir');
    const btnReiniciar = document.getElementById('reiniciar');

    armonicosInp.addEventListener('input', e=>{
      numArmonicos = parseInt(e.target.value,10);
      valorArmonicos.textContent = numArmonicos;
      // reiniciar trazo para ver la nueva convergencia
      trazo.length = 0;
    });

    velocidadInp.addEventListener('input', e=>{
      velocidad = parseFloat(e.target.value);
      valorVelocidad.textContent = velocidad.toFixed(1) + '×';
    });

    btnPausar.addEventListener('click', ()=>{
      reproduciendo = !reproduciendo;
      btnPausar.textContent = reproduciendo ? '⏸ Pausar' : '▶ Reproducir';
    });

    btnReiniciar.addEventListener('click', ()=>{
      t = 0; trazo.length = 0;
    });
  </script>
</body>
</html>
